FROM ubuntu:rolling
LABEL maintainer="dev@systeminit.com"
RUN mkdir /src
WORKDIR /src
COPY . /src
RUN apt-get update -y \
  && apt-get upgrade -y \
  && apt-get install -y build-essential make sudo git \
  && make build_deps \
  && npm config set user 0 \
  && npm config set unsafe-perm true \
  && make build  \
  && apt-get autoremove -y \
  && apt-get clean \
  && find /var/lib/apt/lists -type f | xargs rm \
  && find /var/log -type f -exec rm {} \;  \
  && rm -rf /usr/share/man/* \
  && rm -rf /usr/share/doc/* \
  && rm -f /var/log/alternatives.log /var/log/apt/* \
  && rm /var/cache/debconf/*-old \
  && mkdir -p /build-cache \
  && tar zcvf /build-cache/cargo-cache.tgz /src/target /root/.cargo \
  && tar zcvf /build-cache/npm-cache.tgz /src/components/*/node_modules \
  && rm -rf /src 
