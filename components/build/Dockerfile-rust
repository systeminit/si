FROM ubuntu:rolling as component-builder
ARG component
RUN mkdir /src
WORKDIR /src
COPY . /src
RUN apt-get update -y \
  && apt-get upgrade -y \
  && apt-get install -y build-essential make sudo git \
  && make build_deps \
  && make build build//components/${component} \
  && apt-get autoremove -y \
  && apt-get clean \
  && find /var/lib/apt/lists -type f | xargs rm \
  && find /var/log -type f -exec rm {} \;  \
  && rm -rf /usr/share/man/* \
  && rm -rf /usr/share/doc/* \
  && rm -f /var/log/alternatives.log /var/log/apt/* \
  && rm /var/cache/debconf/*-old
WORKDIR /src/component/${component}
RUN . /root/.cargo/env && cd /src/component/${component} && cargo build

FROM ubuntu:rolling
ARG component
ARG release=debug
RUN env DEBIAN_FRONTEND=noninteractive apt-get update; \
  apt-get -y upgrade; \
  apt-get install -y openssl libev-dev libevent-dev openssh-client; \
  apt-get autoremove -y; \
  apt-get clean; \
  find /var/lib/apt/lists -type f | xargs rm; \
  find /var/log -type f -exec rm {} \; ; \
  rm -rf /usr/share/man/*; \
  rm -rf /usr/share/doc/*; \
  rm -f /var/log/alternatives.log /var/log/apt/*; \
  rm /var/cache/debconf/*-old
RUN mkdir -p /svc/${component}/config
COPY --from=component-builder /src/target/${release}/${component}-server /svc/${component}/
COPY --from=component-builder /src/components/${component}/config/* /svc/${component}/config
COPY --from=component-builder /src/components/build/run.sh /svc
RUN chmod a+x /svc/run.sh
ENV START_SERVICE=${component}
ENTRYPOINT /svc/run.sh
