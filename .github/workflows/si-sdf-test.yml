name: Test si-sdf
on: 
  push:
    paths:
      - 'components/si-sdf/**'
      - 'components/si-settings/**'
      - 'components/si-registry/**'
    branches:
      - '**'
      - '!master'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Docker login
      run: docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Start Development Containers
      run: make test_deps
    - uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Build veritech sidecar
      run: make build//components/si-registry
    - name: Run veritech sidecar
      run: cd components/si-registry && npm run start &
    - name: Install deps
      run: sudo apt-get install lld build-essential cmake clang openssl libev-dev libevent-dev libssl-dev pkg-config
    - name: Install Rust
      uses: actions-rs/toolchain@v1
    - uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Test
      run: make test//components/si-sdf
