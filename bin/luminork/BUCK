load(
    "@prelude-si//:macros.bzl",
    "container_image",
    "rust_binary",
    "rust_binary_artifact",
)

rust_binary(
    name = "luminork",
    deps = [
        "//lib/innit-client:innit-client",
        "//lib/luminork-server:luminork-server",
        "//lib/si-service:si-service",
        "//third-party/rust:clap",
    ],
    srcs = glob(["src/**/*.rs"]),
    env = {"CARGO_BIN_NAME": "luminork"},
    resources = {
        "dev.jwt_signing_public_key.pem": "//config/keys:dev.jwt_signing_public_key.pem",
        "prod.jwt_signing_public_key.pem": "//config/keys:prod.jwt_signing_public_key.pem",
        "dev.encryption.key": "//lib/veritech-server:dev.encryption.key",
        "dev.postgres.root.crt": "//config/keys:dev.postgres.root.crt",
        "dev.donkey.key": "//lib/dal:dev.donkey.key",
        "pkgs_path": "//pkgs:pkgs",
    },
)

rust_binary_artifact(
    name = "luminork",
    binary = ":luminork"
)

container_image(
    name = "luminork",
    build_args = {
        # Source: https://gcr.io/distroless/cc-debian13:nonroot
        # Copy `Digest` value for exact pinning
        "IMAGE": "gcr.io/distroless/cc-debian13",
        "DIGEST": "sha256:580333af04e2a47e2578007066678939d06ff9c5c6bcbed07f7d9bb46b90b9d4",
    },
    srcs = {
        ":luminork": ".",
    },
)
