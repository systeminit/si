#!/usr/bin/env -S deno run --allow-read --allow-write

/**
 * Generate embedded-templates.ts from template files
 * This script reads template files and embeds them as string constants
 */

import { join } from "@std/path";

const TEMPLATES_DIR = "data/templates";
const OUTPUT_FILE = "src/embedded-templates.ts";

const templates = [
  {
    name: "TEMPLATE_SHELL",
    file: "template.ts.tmpl",
    description: "TypeScript template shell for template generation",
  },
  {
    name: "PROVIDER_COMMON_TEMPLATE",
    file: "providers/common.md.tmpl",
    description: "Common System Initiative context (change sets, MCP server)",
  },
  {
    name: "PROVIDER_AWS_TEMPLATE",
    file: "providers/aws.md.tmpl",
    description: "AWS infrastructure management documentation",
  },
  {
    name: "PROVIDER_AZURE_TEMPLATE",
    file: "providers/azure.md.tmpl",
    description: "Microsoft Azure infrastructure management documentation",
  },
  {
    name: "PROVIDER_HETZNER_TEMPLATE",
    file: "providers/hetzner.md.tmpl",
    description: "Hetzner Cloud infrastructure management documentation",
  },
  {
    name: "PROVIDER_DIGITALOCEAN_TEMPLATE",
    file: "providers/digitalocean.md.tmpl",
    description: "DigitalOcean infrastructure management documentation",
  },
  {
    name: "PROVIDER_GOOGLE_TEMPLATE",
    file: "providers/google.md.tmpl",
    description: "Google Cloud infrastructure management documentation",
  },
];

let output = `/**
 * Embedded Templates - Template content embedded at compile time
 *
 * This file contains template content as string constants to ensure they're
 * always available in compiled binaries, regardless of the build system
 * (deno compile, Buck2, etc.)
 *
 * NOTE: This file is auto-generated by scripts/generate-embedded-templates.ts
 * Do not edit manually. To update templates, edit the source files in data/templates/
 * and run: deno run --allow-read --allow-write scripts/generate-embedded-templates.ts
 */

`;

for (const template of templates) {
  const filePath = join(TEMPLATES_DIR, template.file);
  const content = await Deno.readTextFile(filePath);

  // Escape backticks and backslashes for template literal
  const escapedContent = content
    .replace(/\\/g, "\\\\")
    .replace(/`/g, "\\`")
    .replace(/\$\{/g, "\\${");

  output += `/** ${template.description} */\n`;
  output += `export const ${template.name} = \`${escapedContent}\`;\n\n`;
}

await Deno.writeTextFile(OUTPUT_FILE, output);
console.log(`âœ… Generated ${OUTPUT_FILE}`);
