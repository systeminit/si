#!/usr/bin/env -S deno run --allow-read --allow-write

/**
 * Generate embedded-templates.ts from template files
 * This script reads template files and embeds them as string constants
 */

import { join } from "@std/path";

const TEMPLATES_DIR = "data/templates";
const OUTPUT_FILE = "src/embedded-templates.ts";

const templates = [
  {
    name: "SI_AGENT_CONTEXT_TEMPLATE",
    file: "SI_Agent_Context.md.tmpl",
    description: "SI Agent Context template for CLAUDE.md, AGENTS.md, OPENCODE.md",
  },
  {
    name: "TEMPLATE_SHELL",
    file: "template.ts.tmpl",
    description: "TypeScript template shell for template generation",
  },
];

let output = `/**
 * Embedded Templates - Template content embedded at compile time
 * 
 * This file contains template content as string constants to ensure they're
 * always available in compiled binaries, regardless of the build system
 * (deno compile, Buck2, etc.)
 * 
 * NOTE: This file is auto-generated by scripts/generate-embedded-templates.ts
 * Do not edit manually. To update templates, edit the source files in data/templates/
 * and run: deno run --allow-read --allow-write scripts/generate-embedded-templates.ts
 */

`;

for (const template of templates) {
  const filePath = join(TEMPLATES_DIR, template.file);
  const content = await Deno.readTextFile(filePath);
  
  // Escape backticks and backslashes for template literal
  const escapedContent = content
    .replace(/\\/g, "\\\\")
    .replace(/`/g, "\\`")
    .replace(/\$\{/g, "\\${");
  
  output += `/** ${template.description} */\n`;
  output += `export const ${template.name} = \`${escapedContent}\`;\n\n`;
}

await Deno.writeTextFile(OUTPUT_FILE, output);
console.log(`âœ… Generated ${OUTPUT_FILE}`);
