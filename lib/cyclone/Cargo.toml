[package]
name = "cyclone"
version = "0.1.0"
edition = "2021"
rust-version = "1.56"
publish = false

[features]
# By default, no features are enabled--consumers of this crate need to opt-in
# to the features they desire.
default = []

process = [
  "nix",
  "tokio",
]

# The client implementation for a cyclone server.
client = [
  "async-trait",
  "futures",
  "futures-lite",
  "http",
  "hyper",
  "hyperlocal",
  "tokio",
  "tokio-tungstenite",
  "uuid",
]

# The server side implementation of cyclone, as a library.
server = [
  "async-trait",
  "axum",
  "bytes-lines-codec",
  "derive_builder",
  "futures",
  "hyper",
  "nix",
  "pin-project-lite",
  "process",
  "tokio",
  "tokio-serde",
  "tokio-util",
  "tower",
  "tower-http",
  "uuid",
]

[dependencies]
# for common types shared between client and server
serde = { version = "1.0", features = ["derive"] }
serde_json = { version = "1.0", features = ["preserve_order"] }
telemetry = { path = "../../lib/telemetry-rs" }
thiserror = { version = "1.0" }
# These are not optional because they are used in tests too, being optional breaks `cargo test`
chrono = "0.4.19"
# Note: I'm pretty sure this should only be needed in the server part,
# but the datastructures that wrap them are used in the client too
sodiumoxide = "0.2.6"
once_cell = "1.9.0"
base64 = "0.13.0"

# for process shutdown behavior
nix = { version = "0.23.0", optional = true }

# server and/or client
async-trait = { version = "0.1.51", optional = true }
futures = { version = "0.3.17", optional = true }
hyper = { version = "0.14", features = ["client", "http1", "runtime", "server"], optional = true }
tokio = { version = "1.12.0", features = ["full"], optional = true }
uuid = { version = "0.8.2", features = ["serde", "v4"], optional = true }

# client only
futures-lite = { version = "1.12.0", optional = true }
http = { version = "0.2.5", optional = true }
hyperlocal = { version = "0.8.0", default-features = false, features = ["client"], optional = true }
tokio-tungstenite = { version = "0.15.0", optional = true }

# server only
axum = { version = "0.2.5", features = ["ws"], optional = true }
bytes-lines-codec = { path = "../bytes-lines-codec", optional = true }
derive_builder = { version = "0.10.2", optional = true }
pin-project-lite = { version = "0.2.7", optional = true }
tokio-serde = { version = "0.8.0", features = ["json"], optional = true }
tokio-util = { version = "0.6.8", features = ["codec"], optional = true }
tower = { version = "0.4.8", optional = true }
tower-http = { version = "0.1", features = ["trace"], optional = true }

[dev-dependencies]
tempfile = { version = "3.2.0" }
test-env-log = { version = "0.2.7", default-features = false, features = ["trace"] }
tracing = { version = "0.1" }
tracing-subscriber = { version = "0.2.19", default-features = false, features = ["env-filter", "fmt"] }
