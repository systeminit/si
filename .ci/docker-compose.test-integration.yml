---
version: "3"

services:
  app:
    image: systeminit/ci-base:stable
    environment:
      - "SI_TEST_PG_HOSTNAME=postgres"
      # NOTE: We want to set this to the default postgres port as the tests run
      # in *this* container and we're accessing postgres in a peer container
      # and not using the external port mapping.
      - "SI_TEST_PG_PORT=5432"
      - "SI_TEST_NATS_URL=nats"
      - "OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4317"
    depends_on:
      - postgres
      - nats
      - jaeger
      - otelcol

  # NOTE: this db is the same configuration as `postgres-test` under
  # `dev/docker-compose.platform.yml`. In the CI environment, there should be
  # *no* need for the `postgres` service as we aren't running the full service
  # stack.
  postgres:
    image: systeminit/postgres:stable
    environment:
      - "POSTGRES_PASSWORD=bugbear"
      - "PGPASSWORD=bugbear"
      - "POSTGRES_USER=si_test"
      - "POSTGRES_DB=si_test"
      - "POSTGRES_MULTIPLE_DBS=si_test_dal,si_test_sdf_server"
    command:
      - "-c"
      - "fsync=off"
      - "-c"
      - "full_page_writes=off"

  nats:
    image: systeminit/nats:stable
    command:
      - "--config"
      - "nats-server.conf"
      - "-DVV"

  jaeger:
    image: systeminit/jaeger:stable

  otelcol:
    image: systeminit/otelcol:stable
    depends_on:
      - jaeger

  localstack:
    image: localstack/localstack:3
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
